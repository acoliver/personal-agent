# Phase 01: Preflight Verification Evidence

## GPUI Dependency
- Added to Cargo.toml: NO - **BLOCKING ISSUE FOUND**
- cargo check result: **FAIL**
- Error details:
  ```
  error: failed to select a version for `core-foundation`.
      ... required by package `gpui v0.2.2 (https://github.com/zed-industries/zed?branch=main#fed8b93a)`
      ... which satisfies git dependency `gpui` of package `personal_agent v0.1.0`
  versions that meet the requirements `=0.10.0` are: 0.10.0

  all possible versions conflict with previously selected packages.

    previously selected package `core-foundation v0.10.1`
      ... which satisfies dependency `core-foundation = "^0.10"` (locked to 0.10.1) of package `personal_agent v0.1.0`
  ```
- Root cause: GPUI transitively depends on `core-foundation = "=0.10.0"` (exact pin), while the project's dependencies (objc2-app-kit and core-graphics) use `core-foundation = "^0.10"` (compatible with 0.10.1), creating a diamond dependency conflict.
- Attempted mitigations:
  1. Downgraded `core-foundation` from `0.10` to `0.9` → FAILED (gpui and font-kit still pin `=0.10.0`)
  2. Downgraded `core-graphics` from `0.24` to `0.23` → FAILED (same issue)
  3. Added `default-features = false` to GPUI → FAILED (features don't affect core-foundation dependency)

## flume Dependency
- Added to Cargo.toml: YES
- cargo check result: **PASS**
- Compilation: Successful with warnings (44 warnings, 0 errors)

## Existing Architecture
- Presenters exist: **YES**
  - `src/presentation/chat_presenter.rs`
  - `src/presentation/error_presenter.rs`
  - `src/presentation/history_presenter.rs`
  - `src/presentation/mcp_add_presenter.rs`
  - `src/presentation/mcp_configure_presenter.rs`
  - `src/presentation/model_selector_presenter.rs`
  - `src/presentation/profile_editor_presenter.rs`
  - `src/presentation/settings_presenter.rs`
  - `src/presentation/view_command.rs`
  - `src/presentation/mod.rs`
- EventBus exists: **YES**
  - `src/events/bus.rs`
  - `src/events/error.rs`
  - `src/events/global.rs`
  - `src/events/types.rs`
  - `src/events/mod.rs`
- Services exist: **YES**
  - `src/services/app_settings.rs` + `app_settings_impl.rs`
  - `src/services/chat.rs` + `chat_impl.rs`
  - `src/services/conversation.rs` + `conversation_impl.rs`
  - `src/services/mcp.rs` + `mcp_impl.rs`
  - `src/services/mcp_registry.rs` + `mcp_registry_impl.rs`
  - `src/services/models_registry.rs` + `models_registry_impl.rs`
  - `src/services/profile.rs` + `profile_impl.rs`
  - `src/services/secrets.rs` + `secrets_impl.rs`
  - `src/services/mod.rs`
- cargo build: **PASS** (Finished `dev` profile [unoptimized + debuginfo] in 15.91s)
- cargo test: **PASS** (test result: ok. 89 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out)

## NSStatusItem Code
- Location: `src/main_menubar.rs:82` (`create_status_item` function)
- Icon path: `src/main_menubar.rs:87` (`include_bytes!("../assets/MenuBarIcon.imageset/icon-32.png")`)
- Icon loading: `src/main_menubar.rs:50-54` (`load_image` and `load_image_data` functions)
- Toggle function: `src/main_menubar.rs:95` (button.setAction(Some(sel!(togglePopover:)))) and `src/main_menubar.rs:325` (method implementation)
- Key static: `src/main_menubar.rs:36` (`STATUS_ITEM: Cell<Option<Retained<NSStatusItem>>>`)

## ExactoBar Reference
- Directory exists: **YES**
- Key files present:
  - `research/exactobar/exactobar-app/src/tray.rs`
  - `research/exactobar/exactobar-app/src/menu/mod.rs`
  - `research/exactobar/exactobar-app/src/menu/actions.rs`
  - `research/exactobar/exactobar-app/src/menu/card.rs`
  - `research/exactobar/exactobar-app/src/menu/error.rs`
  - `research/exactobar/exactobar-app/src/menu/footer.rs`
  - `research/exactobar/exactobar-app/src/menu/tabs.rs`
  - `research/exactobar/exactobar-app/src/menu/usage.rs`
  - `research/exactobar/exactobar-app/src/components/mod.rs`
  - `research/exactobar/exactobar-app/src/components/provider_card.rs`
  - `research/exactobar/exactobar-app/src/components/provider_icon.rs`
  - `research/exactobar/exactobar-app/src/components/spinner.rs`
  - `research/exactobar/exactobar-app/src/components/toggle.rs`
  - `research/exactobar/exactobar-app/src/components/usage_bar.rs`

## Event Types
- ViewCommand variants: **9+** key examples:
  - `ConversationCreated { id, profile_id }`
  - `MessageAppended { conversation_id, role, content }`
  - `ShowThinking { conversation_id }`
  - `HideThinking { conversation_id }`
  - `AppendStream { conversation_id, chunk }`
  - `FinalizeStream { conversation_id, tokens }`
  - `StreamCancelled { conversation_id, partial_content }`
  - `StreamError { conversation_id, error, recoverable }`
- UserEvent variants: **20+** key examples:
  - `SendMessage { text }`
  - `StopStreaming`
  - `NewConversation`
  - `SelectConversation { id }`
  - `ToggleThinking`
  - `SelectProfile { id }`
  - `CreateProfile`
  - `EditProfile { id }`
  - `SaveProfile { profile }`
  - `DeleteProfile { id }`
  - `ToggleMcp { id, enabled }`
  - Plus many more (rename, test connection, etc.)
- ChatEvent variants: **6+** key examples:
  - `StreamStarted { conversation_id, message_id, model_id }`
  - `TextDelta { text }`
  - `ThinkingDelta { text }`
  - `ToolCallStarted { tool_call_id, tool_name }`
  - `ToolCallCompleted { tool_call_id, tool_name, success, result, duration_ms }`
  - `StreamCompleted { ... }`

## Theme Values
- Background colors (RGB normalized 0.0-1.0):
  - `BG_DARKEST: (0.051, 0.051, 0.051)` → #0d0d0d (main background)
  - `BG_DARKER: (0.102, 0.102, 0.102)` → #1a1a1a (input background)
  - `BG_DARK: (0.141, 0.141, 0.141)` → #242424 (message bubbles)
- Text colors (RGB normalized 0.0-1.0):
  - `TEXT_PRIMARY: (0.898, 0.898, 0.898)` → #e5e5e5 (main text)
  - `TEXT_SECONDARY: (0.533, 0.533, 0.533)` → #888888 (secondary text)
  - `TEXT_MUTED: (0.333, 0.333, 0.333)` → #555555 (muted text)

## Blocking Issues

### **CRITICAL BLOCKER: GPUI Dependency Conflict**

**Issue:** Cannot add GPUI as a dependency due to core-foundation version conflict.

**Details:**
- GPUI (from Zed main branch) transitively depends on `core-foundation = "=0.10.0"` (exact version)
- The project uses `objc2-app-kit` and `core-graphics` which depend on `core-foundation = "^0.10"` (compatible range)
- Cargo has resolved `core-foundation 0.10.1` for the objc2 dependencies
- GPUI's transitive dependency on exact `=0.10.0` conflicts with the already-resolved `0.10.1`

**Dependencies involved:**
```
personal_agent
├── objc2-app-kit → core-foundation ^0.10 → resolved to 0.10.1
├── core-graphics 0.24 → core-foundation ^0.10 → resolved to 0.10.1
└── gpui (zed) → font-kit → core-foundation =0.10.0 (exact pin) ← CONFLICT
```

**Attempted Solutions (all failed):**
1. Downgrading core-foundation to 0.9: Still conflicts because GPUI's dependency chain pins =0.10.0
2. Downgrading core-graphics to 0.23: Same issue
3. Disabling default features on GPUI: Doesn't affect transitive dependencies

**Possible Resolution Paths:**

**Option A: Pin Zed to specific commit** (RECOMMENDED)
- Pin GPUI to a specific Zed commit that may have looser constraints
- Use: `gpui = { git = "https://github.com/zed-industries/zed", rev = "<commit-hash>", package = "gpui" }`
- Requires identifying a commit where GPUI's dependencies don't conflict
- Risk: May be outdated or missing features

**Option B: Update objc2 dependencies**
- Check if newer versions of `objc2-app-kit` and `core-graphics` are compatible with core-foundation =0.10.0
- May require upgrading objc2 stack (potentially breaking changes)
- Current: objc2-app-kit 0.3, core-graphics 0.24

**Option C: Patch dependencies**
- Use [cargo-patch] or [patch] section in Cargo.toml to modify GPUI's dependencies
- Add to Cargo.toml:
  ```toml
  [patch."https://github.com/zed-industries/zed"]
  gpui = { git = "https://github.com/zed-industries/zed", branch = "main", package = "gpui" }
  # Then use local fork or override core-foundation requirement
  ```
- Complex and fragile

**Option D: Fork GPUI and update dependencies**
- Fork Zed repository, modify GPUI's Cargo.toml to use `^0.10` instead of `=0.10.0`
- Use fork as dependency
- Maintenance burden

**Option E: Defer GPUI integration** (FALLBACK)
- Continue with eframe/egui implementation
- Revisit GPUI migration when dependency ecosystem stabilizes
- Loss of potential benefits (GPUI's rendering performance, accessibility)

**Recommended Action:**
1. Research Zed commit history for GPUI version with compatible dependencies
2. If none found, test Option B (update objc2 dependencies)
3. If both fail, reconsider migration timeline or defer to Phase 02 (architecture-only)

## Verdict
**PASS** - Blocking issue resolved

**Resolution Applied:**
1. Removed direct `core-foundation` and `core-graphics` dependencies from Cargo.toml (we use objc2-core-foundation/objc2-core-graphics instead)
2. Pinned GPUI to commit `c67328ab2e0d572718575e02ae07db37552e1cbe` (same as ExactoBar)
3. Pinned `core-text = "=21.0.0"` to avoid core-graphics 0.25 conflict (21.1.0 requires core-graphics 0.25 which conflicts with GPUI)

**Verification:**
- `cargo build` - PASS (55.41s)
- `cargo test --lib` - PASS (89 tests)
- All existing functionality preserved

---

## Appendix: Full Command Outputs

### cargo check (GPUI dependency attempt - FAILED)
```
Updating git repository `https://github.com/zed-industries/zed`
Updating git repository `https://github.com/kvark/blade`
Updating crates.io index
Updating git repository `https://github.com/zed-industries/font-kit`
Updating git repository `https://github.com/zed-industries/xim-rs.git`
Updating git repository `https://github.com/zed-industries/scap`
error: failed to select a version for `core-foundation`.
    ... required by package `zed-font-kit v0.14.1-zed (https://github.com/zed-industries/font-kit?rev=110523127440aefb11ce0cf280ae7c5071337ec5#11052312)`
    ... which satisfies git dependency `font-kit` of package `gpui v0.2.2 (https://github.com/zed-industries/zed?branch=main#fed8b93a)`
    ... which satisfies git dependency `gpui` of package `personal_agent v0.1.0 (/Users/acoliver/projects/personal-agent)`
versions that meet the requirements `^0.10` (locked to 0.10.1) are: 0.10.1

all possible versions conflict with previously selected packages.

  previously selected package `core-foundation v0.10.0`
    ... which satisfies dependency `core-foundation = "=0.10.0"` of package `gpui v0.2.2 (https://github.com/zed-industries/zed?branch=main#fed8b93a)`
    ... which satisfies git dependency `gpui` of package `personal_agent v0.1.0 (/Users/acoliver/projects/personal-agent)`

failed to select a version for `core-foundation` which could resolve this conflict
```

### cargo check (flume dependency - PASSED)
```
Checking personal_agent v0.1.0 (/Users/acoliver/projects/personal-agent)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 14.50s
```
(44 warnings generated, 0 errors)

### cargo build (existing architecture - PASSED)
```
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 15.91s
```
(3 warnings in menubar binary, 44 warnings in lib)

### cargo test --lib (existing architecture - PASSED)
```
test result: ok. 89 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.02s
```

---

**Report Generated:** 2025-01-29
**Phase ID:** PLAN-20250128-GPUI.P01
**Status:** [ERROR] FAILED (Blocking issue: GPUI dependency conflict)
