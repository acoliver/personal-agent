# Phase 02: Analysis Evidence

## Phase ID
`PLAN-20250128-GPUI.P02`

## Analysis Complete
- View mapping: YES
- Component hierarchy: YES
- Data flow diagram: YES
- State management: YES
- ExactoBar patterns: YES
- Bridge architecture: YES

## Pseudocode Files Created
- [x] analysis/pseudocode/app.md (150 lines) - Application setup, event loop, popup management
- [x] analysis/pseudocode/main_panel.md (250 lines) - Root component, tab navigation, ViewCommand handling
- [x] analysis/pseudocode/chat_view.md (360 lines) - Messages, input bar, streaming UI
- [x] analysis/pseudocode/components.md (400 lines) - Reusable components (Icon, Button, Toggle, etc.)
- [x] analysis/pseudocode/bridge.md (230 lines) - GpuiBridge, ViewCommandSink, TrayBridge

**Total pseudocode: ~1390 lines**

## Key Architectural Decisions

### 1. Runtime Bridge (flume channels)
- `flume` for cross-runtime communication (GPUI/smol <-> tokio)
- Bounded channels: UserEvent(256), ViewCommand(1024)
- GpuiNotifier (AtomicBool) for waking GPUI event loop

### 2. State Ownership
- MainPanel owns all view state (ChatState, HistoryState, SettingsState)
- Sub-views receive state by reference (`&ChatState`)
- ViewCommands mutate MainPanel state, trigger `cx.notify()`

### 3. Event Flow (Confirmed)
```
GPUI Click -> GpuiBridge.emit_user_event() -> flume -> forwarder -> EventBus
EventBus -> Presenter -> ViewCommandSink.send() -> flume -> GPUI.drain_view_commands()
```

### 4. NSStatusItem Integration
- Reuse existing `main_menubar.rs` patterns
- TrayBridge wraps NSStatusItem + flume channel
- Popup positioned below status item using `convertRectToScreen`

### 5. Component Patterns
- Stateful components: `Render` trait (MainPanel, ChatView)
- Stateless components: `IntoElement` trait (UserBubble, Button, Icon)
- Builder pattern for configuration (Button::new().variant().on_click())

## View Mapping

| AppKit View | GPUI Component | Pseudocode |
|-------------|----------------|------------|
| chat_view.rs (~980 lines) | ChatView | chat_view.md |
| history_view.rs (~779 lines) | HistoryView | (outlined in main_panel.md) |
| settings_view.rs (~1191 lines) | SettingsView | (outlined in main_panel.md) |
| theme.rs (~91 lines) | theme.rs | (constants referenced throughout) |
| main_menubar.rs | TrayBridge + app.rs | app.md, bridge.md |

## Open Questions (Resolved)

1. **Q: How to access TextArea value on submit?**
   A: Use GPUI's text input state management (documented in chat_view.md)

2. **Q: Markdown rendering in messages?**
   A: Deferred to Phase 07+ (component implementation)

3. **Q: Animation system for streaming indicator?**
   A: Use GPUI's `with_animation()` API (documented in components.md)

## Dependencies Verified

- gpui v0.2.2 (pinned commit c67328ab)
- flume v0.11.1
- Existing: EventBus, presenters, services (89 tests passing)

## Verdict
**PASS**

All analysis tasks completed. Pseudocode provides clear implementation roadmap for Phases 03-06.

---
**Report Generated:** 2025-01-29
**Phase ID:** PLAN-20250128-GPUI.P02
**Status:** PASS
