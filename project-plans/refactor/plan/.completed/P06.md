Phase: P06
Completed: 2026-01-28 01:38
Files Created:
  - project-plans/refactor/plan/.completed/P06.md (this file)
Files Modified:
  - src/events/bus.rs (replaced all unimplemented!() with real implementations)
  - src/events/global.rs (replaced all unimplemented!() with real implementations)
Implementation Details:

  **bus.rs changes:**
  - EventBus struct: Removed `_rx` field, kept only `sender: broadcast::Sender<AppEvent>`
  - new(capacity: usize): Creates broadcast channel with given capacity
    - Returns Self { sender }
    - No receiver stored (not needed to keep channel alive)
  - publish(event: AppEvent): Publishes event to all subscribers
    - Returns Ok(count) with number of subscribers who received event
    - Returns Err(EventBusError::NoSubscribers) when no subscribers exist
  - subscribe(): Creates new receiver for event stream
    - Returns broadcast::Receiver<AppEvent>
  - subscriber_count(): Returns active subscriber count
    - Calls sender.receiver_count()

  **global.rs changes:**
  - GLOBAL_BUS: OnceLock<EventBus> static for singleton pattern
  - get_or_init_event_bus(): Internal helper for lazy initialization
    - Creates EventBus with capacity=16 on first call
    - Returns &'static EventBus reference
  - init_event_bus(): Public initialization function
    - Returns Result<(), EventBusError>
    - Idempotent (safe to call multiple times)
  - emit(event: AppEvent): Global event emission
    - Initializes bus if needed
    - Returns Result<(), EventBusError>
  - subscribe(): Global subscription
    - Initializes bus if needed
    - Returns broadcast::Receiver<AppEvent>

Test Fixes:
  - Fixed test_ev_t5_multiple_event_types: Store UUIDs before publishing
    - Previously created new UUIDs in expected values, causing mismatch
    - Now creates mcp_id, profile_id, conversation_id before publishing
Test Results:
  - Compilation: PASS (cargo build --all-targets succeeded)
  - Test run: PASS (cargo test -- --test-threads=1: 18/18 passed)
  - All EventBus tests passing:
    - test_event_bus_creation: [OK]
    - test_single_subscription: [OK]
    - test_multiple_subscriptions: [OK]
    - test_publish_to_single_subscriber: [OK]
    - test_ev_t1_delivers_to_all_subscribers: [OK]
    - test_publish_no_subscribers_error: [OK]
    - test_ev_t2_events_delivered_in_order: [OK]
    - test_ev_t3_slow_subscriber_doesnt_block_fast: [OK]
    - test_ev_t5_multiple_event_types: [OK] (FIXED)
    - test_ev_t6_send_message_flow: [OK]
    - test_ev_t7_mcp_toggle_flow: [OK]
    - test_ev_t8_error_events: [OK]
  - All integration tests passing (148 total tests passed)
Verification:
  - Plan markers (@plan:PLAN-20250125-REFACTOR.P06): Present in implementations
  - Requirement markers (@requirement:REQ-021.*): Present in implementations
  - Pseudocode references: Present in implementations
  - No unimplemented!() macros remaining in bus.rs or global.rs
  - All functions return appropriate types
  - Error handling matches EventBusError enum
Architecture Notes:
  - EventBus uses tokio::sync::broadcast channel
  - No receiver needed to keep channel alive (broadcast channel self-sustaining)
  - Global singleton pattern uses std::sync::OnceLock for thread-safe lazy init
  - Default capacity: 16 events (configurable via new())
  - Publisher receives count of subscribers who got the event
  - No subscribers = error (prevents silent event dropping)
