# Phase 01: Wire ChatService to Agent Evidence

## Date: 2025-01-27

## Verification

### AgentClientExt imported
```
$ grep -n "AgentClientExt" src/services/chat_impl.rs
10:use crate::llm::AgentClientExt;
161:            // Create Agent with MCP tools (uses existing AgentClientExt)
```

### create_agent called
```
$ grep -n "create_agent" src/services/chat_impl.rs
163:            let agent = match client.create_agent(mcp_tools, system_prompt).await {
```

### run_agent_stream called
```
$ grep -n "run_agent_stream" src/services/chat_impl.rs
180:            if let Err(e) = client.run_agent_stream(&agent, &messages, |event| {
204:                    // Tool events are handled INSIDE run_agent_stream
```

### request_stream_with_tools removed
```
$ grep -n "request_stream_with_tools" src/services/chat_impl.rs
NOT FOUND (as expected)
```

### pending_tool_calls removed
```
$ grep -n "pending_tool_calls" src/services/chat_impl.rs
NOT FOUND (as expected)
```

### Build
```
$ cargo build --lib 2>&1 | tail -5
warning: `personal_agent` (lib) generated 39 warnings (run `cargo fix --lib -p personal_agent` to apply 20 suggestions)
   Compiling personal_agent v0.1.0 (/Users/acoliver/projects/personal-agent)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 8.87s
```

### Tests
```
$ cargo test --lib services::chat 2>&1 | tail -10
running 11 tests
test services::chat::tests::test_stream_event_complete ... ok
test services::chat::tests::test_stream_event_token ... ok
test services::chat::tests::test_service_result_type ... ok
test services::chat::tests::test_stream_event_traits ... ok
test services::chat::tests::test_stream_event_error ... ok
test services::chat::tests::test_service_error_validation ... ok
test services::chat::tests::test_service_error_not_found ... ok
test services::chat::tests::test_stream_type ... ok
test services::chat_impl::tests::test_cancel ... ok
test services::chat_impl::tests::test_is_streaming ... ok
test services::chat_impl::tests::test_send_message ... ok

test result: ok. 11 passed; 0 failed; 0 ignored; 0 measured; 175 filtered out; finished in 0.00s
```

## Summary

### Changes Made

1. **Made `client_agent` module public** in `src/llm/mod.rs` (changed from `mod` to `pub mod`)
2. **Added import** in `src/services/chat_impl.rs`:
   - `use crate::llm::AgentClientExt;`
3. **Replaced streaming call** in `send_message()`:
   - Removed `client.request_stream_with_tools()` (bypassed Agent)
   - Added `client.create_agent(mcp_tools, system_prompt).await`
   - Added `client.run_agent_stream(&agent, &messages, callback).await`
4. **Removed dead code**: Deleted `pending_tool_calls` vector (no longer needed, Agent handles tools internally)
5. **Fixed error handling**: Properly handle Result from async methods in the spawn closure

### Code Flow

**Before:**
```
ChatService → LlmClient.request_stream_with_tools() → Raw LLM API
                                                           ↓
                                                  Tools collected but never executed
```

**After:**
```
ChatService → LlmClient.create_agent() → Agent (with MCP tools)
                 ↓
          LlmClient.run_agent_stream() → Agent stream
                                              ↓
                                    Agent executes tools internally
```

### Requirement Mapping

- **AGENT-001**: ✅ `create_agent()` builds Agent with MCP tools
- **AGENT-003**: ✅ System prompt extracted from conversation and passed to Agent
- **AGENT-005**: ✅ `run_agent_stream()` handles Agent streaming
- **AGENT-006**: ✅ Tool execution handled internally by Agent via `McpToolExecutor`
- **REM-004**: ✅ MCP tools passed to Agent
- **REM-007**: ✅ Tool use requests handled by Agent (no dead code)

## Verdict

**PASS** - All verification checks passed, build succeeds, tests pass.
